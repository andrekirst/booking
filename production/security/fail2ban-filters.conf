# Fail2ban Custom Filters für Booking System

# =============================================================================
# BOOKING API AUTHENTICATION FAILURES
# =============================================================================
[INCLUDES]
before = common.conf

[Definition]
# Booking API Login Failures - .NET Core Logs
failregex = .*\[ERROR\].*Authentication failed for user.*from IP: <HOST>.*
            .*\[WARNING\].*Invalid login attempt from <HOST>.*
            .*\[ERROR\].*JWT token validation failed.*IP: <HOST>.*
            .*\[WARNING\].*Multiple failed login attempts from <HOST>.*
            .*POST /api/auth/login.*401.*<HOST>.*
ignoreregex =

[booking-bruteforce]
[INCLUDES]
before = common.conf

[Definition]
# Brute Force Detection - Multiple rapid requests
failregex = ^<HOST> -.*"POST /api/auth/login.*" 401.*
            ^<HOST> -.*"POST /api/auth/register.*" 400.*
            ^<HOST> -.*"POST /api/bookings.*" 401.*
            ^<HOST> -.*"GET /api/.*" 401.*
ignoreregex = ^<HOST> -.*"GET /api/health.*" 200.*

[booking-dos]
[INCLUDES]
before = common.conf

[Definition]
# DoS Attack Detection - Too many requests
failregex = ^<HOST> -.*$
ignoreregex = ^<HOST> -.*"GET /health.*" 200.*
              ^<HOST> -.*"GET /nginx-health.*" 200.*
              ^<HOST> -.*"GET /.*\.(css|js|png|jpg|gif|ico|svg|woff|woff2|ttf|eot).*" 200.*

[booking-rate-limit]
[INCLUDES]  
before = common.conf

[Definition]
# Rate Limit Exceeded - Nginx 429 responses
failregex = ^<HOST> -.*" 429 .*
            ^<HOST> -.*" 503 .*"rate limiting".*
ignoreregex =

[booking-monitoring]
[INCLUDES]
before = common.conf

[Definition]
# System Monitoring Events - Critical errors
failregex = .*\[CRITICAL\].*<HOST>.*
            .*\[FATAL\].*<HOST>.*
            .*\[ERROR\].*Database connection failed.*<HOST>.*
            .*\[ERROR\].*Memory allocation failed.*<HOST>.*
ignoreregex =

# =============================================================================
# NGINX SPECIFIC FILTERS (Extended)
# =============================================================================
[nginx-bad-request]
[INCLUDES]
before = common.conf

[Definition]
# Bad HTTP Requests
failregex = ^<HOST> -.*"(GET|POST|HEAD).*HTTP/[0-9].[0-9]" 400 .*
            ^<HOST> -.*".*" 414 .*
            ^<HOST> -.*".*" 413 .*
ignoreregex =

[nginx-malicious-requests]
[INCLUDES]
before = common.conf

[Definition]
# Malicious Request Patterns
failregex = ^<HOST> -.*"(GET|POST|HEAD).*(union|select|insert|update|delete|drop|create|alter).*".*
            ^<HOST> -.*"(GET|POST|HEAD).*(\.\./|\.\.\\\|%2e%2e%2f|%2e%2e\\\\).*".*
            ^<HOST> -.*"(GET|POST|HEAD).*(exec|eval|system|shell_exec|passthru).*".*
            ^<HOST> -.*"(GET|POST|HEAD).*(phpinfo|php_info).*".*
ignoreregex =

[nginx-vulnerability-scan]
[INCLUDES]
before = common.conf

[Definition]
# Vulnerability Scanning Detection
failregex = ^<HOST> -.*"(GET|POST|HEAD).*(wp-admin|wp-login|admin|administrator|phpmyadmin|mysql|postgres).*" 404.*
            ^<HOST> -.*"(GET|POST|HEAD).*\.php.*" 404.*
            ^<HOST> -.*"(GET|POST|HEAD).*(config|backup|dump|log).*\.(sql|txt|log|bak).*" 404.*
ignoreregex =

# =============================================================================
# POSTGRESQL SPECIFIC FILTERS
# =============================================================================
[postgresql-auth]
[INCLUDES]
before = common.conf

[Definition]
# PostgreSQL Authentication Failures
failregex = .*FATAL:.*authentication failed for user.*from <HOST>.*
            .*FATAL:.*password authentication failed for user.*from <HOST>.*
            .*FATAL:.*no pg_hba.conf entry for host "<HOST>".*
            .*LOG:.*connection authorized:.*from <HOST>.*authentication failed.*
ignoreregex =

[postgresql-dos]
[INCLUDES]
before = common.conf

[Definition]  
# PostgreSQL DoS Attacks
failregex = .*FATAL:.*too many connections for role.*from <HOST>.*
            .*FATAL:.*remaining connection slots are reserved.*from <HOST>.*
            .*LOG:.*could not accept SSL connection.*from <HOST>.*
ignoreregex =

# =============================================================================
# SYSTEM LEVEL FILTERS für Pi Zero 2 W
# =============================================================================
[system-resource-exhaustion]
[INCLUDES]
before = common.conf

[Definition]
# Resource Exhaustion Detection (Memory, CPU)
failregex = .*kernel:.*Out of memory:.*killed process.*
            .*systemd.*Failed to start.*booking.*
            .*docker.*Container.*booking.*exited with code.*
ignoreregex =

[system-network-abuse]  
[INCLUDES]
before = common.conf

[Definition]
# Network-level abuse (auf Raspberry Pi relevant)
failregex = .*kernel:.*TCP: Dropping SYNACK.*<HOST>.*
            .*kernel:.*possible SYN flooding.*<HOST>.*
            .*kernel:.*nf_conntrack: table full.*<HOST>.*
ignoreregex =