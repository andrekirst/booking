name: Minimal Mutation Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'src/backend/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/backend/**'

jobs:
  minimal-mutation-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore
      working-directory: src/backend

    - name: Build
      run: dotnet build --no-restore --configuration Release
      working-directory: src/backend

    - name: Run specific unit tests only
      run: dotnet test --no-build --configuration Release --verbosity normal --filter "FullyQualifiedName~JwtService|FullyQualifiedName~ValidationExtensions"
      working-directory: src/backend

    - name: Install Stryker.NET
      run: dotnet tool install -g dotnet-stryker

    - name: Run minimal Stryker mutation tests
      run: |
        timeout 120 dotnet stryker \
          --project Booking.Api.csproj \
          --test-project Booking.Api.Tests.csproj \
          --reporter Progress,Html \
          --threshold-high 60 \
          --threshold-low 40 \
          --break-at 20 \
          --concurrency 1 \
          --mutate "**/Services/JwtService.cs" \
          --verbosity info \
          --additional-timeout 10000 || echo "Stryker completed with timeout"
      working-directory: src/backend

    - name: Check if Stryker output exists
      run: |
        if [ -d "StrykerOutput" ]; then
          echo "✅ Stryker output directory found"
          find StrykerOutput -name "*.html" -o -name "*.json" | head -5
        else
          echo "❌ No Stryker output found"
        fi
      working-directory: src/backend

    - name: Upload Minimal Stryker Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: minimal-stryker-report
        path: src/backend/StrykerOutput/**/*.html
        retention-days: 7

    - name: Mutation Test Summary
      run: |
        echo "## 🧬 Minimal Mutation Test Results" >> $GITHUB_STEP_SUMMARY
        echo "This is a minimal demonstration of Stryker.NET mutation testing." >> $GITHUB_STEP_SUMMARY
        echo "- **Target**: JwtService.cs" >> $GITHUB_STEP_SUMMARY
        echo "- **Timeout**: 2 minutes for CI efficiency" >> $GITHUB_STEP_SUMMARY
        echo "- **Purpose**: Validate mutation testing integration" >> $GITHUB_STEP_SUMMARY